<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¥ rrweb SSE æµå¼å›æ”¾</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; margin:0; background:#f5f5f5 }
    header { background:#4a90e2; color:#fff; padding:1rem; text-align:center }
    #app { max-width:900px; margin:2rem auto; background:#fff; padding:2rem; border-radius:8px }
    input, button { width:100%; padding:0.5rem; margin-bottom:1rem; font-size:1rem;border:1px solid #ccc;border-radius:4px }
    button { background:#2d8cf0; color:#fff; cursor:pointer; }
    button:hover { background:#1a73e8 }
    #replay { margin-top:1rem; height:500px; background:#222;color: #ccc;text-align: center;font-size: small; }
    .error { color:red; margin-top:0.5rem }
    .loading { color:#888; }
  </style>
</head>
<body>
  <header>ğŸ¥ SSE æµå¼ rrweb å›æ”¾å·¥å…·</header>
  <div id="app">
    <input id="sessionInput" placeholder="è¯·è¾“å…¥ Session ID..." />
    <button id="startBtn">å¼€å§‹å›æ”¾</button>
    <div id="status" class="loading"></div>
    <div id="replay">ç­‰å¾…æ•°æ®æ¨é€...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
  <script>
    const sessionInput = document.getElementById('sessionInput');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const replayEl = document.getElementById('replay');

    let player = null;
    let eventSource = null;

    // Web Worker åˆ›å»º
    const worker = new Worker(URL.createObjectURL(new Blob([`
      importScripts('https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js');
      self.onmessage = e => {
        try {
          const base64 = e.data;
          const str = atob(base64);
          const bytes = new Uint8Array(str.length);
          for (let i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
          const json = pako.inflate(bytes, { to: 'string' });
          self.postMessage({ success: true, json });
        } catch (err) {
          self.postMessage({ success: false, error: err.message });
        }
      };
    `])));

    worker.onmessage = e => {
      if (!player) return;
      if (e.data.success) {
        try {
          const events = JSON.parse(e.data.json);
          player.addEvent(events);
          statusEl.textContent = 'å·²åŠ è½½ ' + player.getEvents().length + ' æ¡äº‹ä»¶';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'âŒ JSON è§£æå¤±è´¥';
        }
      } else {
        console.error(e.data.error);
        statusEl.textContent = 'âŒ è§£å‹å¤±è´¥: ' + e.data.error;
      }
    };

    startBtn.onclick = () => {
      const sid = sessionInput.value.trim();
      if (!sid) return statusEl.textContent = 'âš ï¸ è¯·å¡«å†™ Session ID';

      // æ¸…ç†æ—§å®ä¾‹
      if (eventSource) eventSource.close();
      replayEl.innerHTML = '';
      player = null;
      statusEl.textContent = 'ç­‰å¾… SSE æ¨é€...';

      // SSE è¿æ¥
      eventSource = new EventSource(`/api/rrweb-stream?sessionId=${encodeURIComponent(sid)}`);

      eventSource.onmessage = evt => {
        try {
          const data = JSON.parse(evt.data); // { compressed: string, hasNext: boolean }
          const { compressed, hasNext } = data;

          if (!compressed) throw new Error('æ—  compressed æ•°æ®');
          if (!player) {
            // é¦–æ¬¡åˆå§‹åŒ–æ’­æ”¾å™¨
            player = new rrwebPlayer({
              target: replayEl,
              props: { events: [], showController: true }
            });
            statusEl.textContent = 'ç¬¬ä¸€æ¬¡åŠ è½½ä¸­...';
          }

          // è§£å‹å¹¶è¿½åŠ 
          worker.postMessage(compressed);

          if (!hasNext) {
            statusEl.textContent = 'âœ… æ‰€æœ‰äº‹ä»¶åŠ è½½å®Œæˆ';
            eventSource.close();
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'âŒ æ•°æ®æ¨é€æ ¼å¼é”™è¯¯';
          eventSource.close();
        }
      };

      eventSource.onerror = err => {
        console.error('SSE è¿æ¥é”™è¯¯', err);
        statusEl.textContent = 'âŒ SSE è¿æ¥ä¸­æ–­';
        eventSource.close();
      };
    };
  </script>
</body>
</html>
