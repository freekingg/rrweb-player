<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🎥 rrweb SSE 流式回放</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; margin:0; background:#f5f5f5 }
    header { background:#4a90e2; color:#fff; padding:1rem; text-align:center }
    #app { max-width:900px; margin:2rem auto; background:#fff; padding:2rem; border-radius:8px }
    input, button { width:100%; padding:0.5rem; margin-bottom:1rem; font-size:1rem;border:1px solid #ccc;border-radius:4px }
    button { background:#2d8cf0; color:#fff; cursor:pointer; }
    button:hover { background:#1a73e8 }
    #replay { margin-top:1rem; height:500px; background:#222;color: #ccc;text-align: center;font-size: small; }
    .error { color:red; margin-top:0.5rem }
    .loading { color:#888; }
  </style>
</head>
<body>
  <header>🎥 SSE 流式 rrweb 回放工具</header>
  <div id="app">
    <input id="sessionInput" placeholder="请输入 Session ID..." />
    <button id="startBtn">开始回放</button>
    <div id="status" class="loading"></div>
    <div id="replay">等待数据推送...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
  <script>
    const sessionInput = document.getElementById('sessionInput');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const replayEl = document.getElementById('replay');

    let player = null;
    let eventSource = null;

    // Web Worker 创建
    const worker = new Worker(URL.createObjectURL(new Blob([`
      importScripts('https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js');
      self.onmessage = e => {
        try {
          const base64 = e.data;
          const str = atob(base64);
          const bytes = new Uint8Array(str.length);
          for (let i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
          const json = pako.inflate(bytes, { to: 'string' });
          self.postMessage({ success: true, json });
        } catch (err) {
          self.postMessage({ success: false, error: err.message });
        }
      };
    `])));

    worker.onmessage = e => {
      if (!player) return;
      if (e.data.success) {
        try {
          const events = JSON.parse(e.data.json);
          player.addEvent(events);
          statusEl.textContent = '已加载 ' + player.getEvents().length + ' 条事件';
        } catch (err) {
          console.error(err);
          statusEl.textContent = '❌ JSON 解析失败';
        }
      } else {
        console.error(e.data.error);
        statusEl.textContent = '❌ 解压失败: ' + e.data.error;
      }
    };

    startBtn.onclick = () => {
      const sid = sessionInput.value.trim();
      if (!sid) return statusEl.textContent = '⚠️ 请填写 Session ID';

      // 清理旧实例
      if (eventSource) eventSource.close();
      replayEl.innerHTML = '';
      player = null;
      statusEl.textContent = '等待 SSE 推送...';

      // SSE 连接
      eventSource = new EventSource(`/api/rrweb-stream?sessionId=${encodeURIComponent(sid)}`);

      eventSource.onmessage = evt => {
        try {
          const data = JSON.parse(evt.data); // { compressed: string, hasNext: boolean }
          const { compressed, hasNext } = data;

          if (!compressed) throw new Error('无 compressed 数据');
          if (!player) {
            // 首次初始化播放器
            player = new rrwebPlayer({
              target: replayEl,
              props: { events: [], showController: true }
            });
            statusEl.textContent = '第一次加载中...';
          }

          // 解压并追加
          worker.postMessage(compressed);

          if (!hasNext) {
            statusEl.textContent = '✅ 所有事件加载完成';
            eventSource.close();
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = '❌ 数据推送格式错误';
          eventSource.close();
        }
      };

      eventSource.onerror = err => {
        console.error('SSE 连接错误', err);
        statusEl.textContent = '❌ SSE 连接中断';
        eventSource.close();
      };
    };
  </script>
</body>
</html>
